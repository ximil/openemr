
<script type="text/javascript">
		$(function(){
			$('#dg').edatagrid({
				url: './resultShow',
				saveUrl: './resultUpdate',
				updateUrl: './resultUpdate',
				//destroyUrl: 'destroy_user.php'
			});
		});
		
		function doSearch(){
			$('#dg').edatagrid('load',{  
				status: $("input[name=searchStatus]").val(),
				dtFrom: $('#acpro_inp1').val(),
				dtTo: $('#acpro_inp4').val(),
			}); 
		}
		
		function getResult(target) {
			var tr = $(target).closest('tr.datagrid-row');
			var rowIndex = parseInt(tr.attr('datagrid-row-index'));
			$('#dg').datagrid('selectRow', rowIndex);
			var row = $('#dg').datagrid('getSelected'); 
			if (row){  
				var order_id = row.procedure_order_id;
				window.location.assign("./getlabresult?order_id=" + order_id);
			}
		}
		
		function getRequisition(target) {
			var tr = $(target).closest('tr.datagrid-row');
			var rowIndex = parseInt(tr.attr('datagrid-row-index'));
			$('#dg').datagrid('selectRow', rowIndex);
			var row = $('#dg').datagrid('getSelected'); 
			if (row){  
				var order_id = row.procedure_order_id;
				window.location.assign("./getlabrequisition?order_id=" + order_id);
			}
			
			/* $.ajax({
				type: "POST",
				url: "./getlabrequisition",
				data: {
					order_id: order_id,
					},
				success: function(data) {
					//alert('ok');
				},
				error: function(data){
					alert("Ajax Fail");
				}
			});	 */		
		}

</script>
	
	<table id="dg" title="Pending Review"  style="width:auto;height:450px"
			toolbar="#toolbar" pagination="true" idField="procedure_order_id, procedure_result_id, procedure_order_seq, procedure_report_id"
			rownumbers="true" fitColumns="true" singleSelect="true">

			<thead>
			<tr>
				<th colspan="5"><?php echo xlt('Order'); ?></th>
				<th colspan="4"><?php echo xlt('Report'); ?></th>
				<th colspan="7"><?php echo xlt('Results and Recommendations'); ?></th>
				<th colspan="1"><?php echo xlt('Action'); ?></th>
			</tr>
			
			<tr>
			
			<!-- Start Order -->
				<th data-options="field:'date_ordered',width:50"><?php echo xlt('Date'); ?></th>
				<th data-options="field:'procedure_name',width:80"><?php echo xlt('Procedure Name'); ?></th> 
				<th data-options="field:'order_id',width:35, align:'center'"><?php echo xlt('Ord'); ?></th> 
				<th data-options="field:'patient_name',width:50"><?php echo xlt('Patient'); ?></th><th data-options="field:'encounter_id',width:50, align:'center'"><?php echo xlt('Encounter'); ?></th>
			<!-- End Order -->
			
			<!-- Start Report -->
				<th field="date_report" width="70" editor="datebox"><?php echo xlt('Reported'); ?></th>
				<th field="date_collected" width="70" editor="datebox"><?php echo xlt('Ext Time Collected'); ?></th>
				<th field="specimen_num" width="40" editor="text"><?php echo xlt('Specimen'); ?></th>
				<th data-options="field:'report_status',width:50,  
							formatter:function(value,row){  
								return row.report_status;  
							},  
							editor:{  
								type:'combobox',  
								options:{  
									valueField:'status',  
									textField:'status',  
									url:'<?php echo $this->basePath(); ?>/../module/Lab/view/lab/lab/status.json',  
									required:false  
								} 
							}"><?php echo xlt('Status'); ?></th>
			<!-- End Report -->
			
			<!-- Start Results and Recommendations -->
				<th field="result_code" width="40" editor="text"><?php echo xlt('Code'); ?></th>
				<th field="result_text" width="80" editor="text"><?php echo xlt('Name'); ?></th>
				<th data-options="field:'abnormal',width:40,  
							formatter:function(value,row){  
								return row.abnormal;  
							},  
							editor:{  
								type:'combobox',  
								options:{  
									valueField:'abnid',  
									textField:'abn',  
									url:'<?php echo $this->basePath(); ?>/../module/Lab/view/lab/lab/abn.json',  
									required:false  
								} 
							}"><?php echo xlt('Abn'); ?></th>
				<th field="result" width="40" editor="text"><?php echo xlt('Value'); ?></th>
				<th field="pt2_units" width="50" editor="text"><?php echo xlt('Units'); ?></th>
				<th field="pt2_range" width="50" editor="text"><?php echo xlt('Range'); ?></th>
				<th data-options="field:'comments',title:'',width:50,align:'center',
							formatter:function(value,row,index){
								if (row.editing){
									var s = '<a></a> ';
									var c = '<a></a>';
									return s+c;
								} else {
									var r = '<a href=javascript:void(0) class=easyui-linkbutton iconCls=icon-edit plain=true onclick=editUser()><img src=<?php echo $this->basePath() ?>/css/icons/pencil.png /></a>';
									var q = '';
									return r+q;
								}
							}">Comments</th>

			<!-- End Results and Recommendations -->
				<th data-options="field:'action',title:'',width:80,align:'left',
							formatter:function(value,row,index){
								if (row.editing){
									var s = '<a></a> ';
									var c = '<a></a>';
									return s+c;
								} else {
									var e = '<a href=\'#\' onClick=\'getResult(this);\'  style=padding-left:10px; ><img  src=<?php echo $this->basePath() .'/css/icons/pdf_icon.png'; ?> title=<?php echo xlt('Result'); ?>  border=0 /></a><span style=padding-right:30px;>&nbsp;</span>';
									var d = '<a href=\'#\' onClick=\'getRequisition(this);\' ><img  src=<?php echo $this->basePath() .'/css/icons/request.png'; ?> title=<?php echo xlt('Requisition'); ?> border=0 /></a>';
									return e+d;
								}
							}">

							<span  style="width: 20px; border-right: 1px dotted #444;">
							<?php echo xlt('Result'); ?>
							</span>
							<span class="datagrid-cell" style="width: 54px;">
							<?php echo xlt('Requisition'); ?></span>
							
							</th>
		
			<!-- End Action -->
			</tr>
		</thead>
	</table>
	<div id="toolbar">
		<!--<a href="#" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="javascript:$('#dg').edatagrid('addRow')">New</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-remove" plain="true" onclick="javascript:$('#dg').edatagrid('destroyRow')">Destroy</a>-->
		<a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="javascript:$('#dg').edatagrid('saveRow')">Save</a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-undo" plain="true" onclick="javascript:$('#dg').edatagrid('cancelRow')">Cancel</a>
		<div style="text-align: right;">
			Date From: <input class="easyui-datebox" style="width:80px" >
			To: <input class="easyui-datebox" style="width:80px" >
			Status: 
			<select class="easyui-combobox"  panelHeight="auto" style="width:100px" name='searchStatus'>
				<option value="">--Select--</option>
				<option value="final">Final</option>
				<option value="review">Reviewed</option>
				<option value="prelim">Preliminary</option>
				<option value="cancel">Canceled</option>
				<option value="error">Error</option>
				<option value="correct">Corrected</option>
			</select>
		  
			<a href="#" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doSearch()">Search</a>

		</div>
	</div>
	
	<div id="dlg" class="easyui-dialog" style="width:500px;height:380px;padding:10px 20px"  
            closed="true" buttons="#dlg-buttons">  
        <div class="ftitle">Blood Group Test</div>  
        <form id="fm" method="post" novalidate>  
            <div class="fitem">  
                <label>Status:</label>  
                <!--<input name="firstname" class="easyui-validatebox" required="true"> -->
				<select class="easyui-combobox"  panelHeight="auto" style="width:100px">
				<option value="">--Select--</option>
				<option value="final">Final</option>
				<option value="review">Reviewed</option>
				<option value="prelim">Preliminary</option>
				<option value="cancel">Canceled</option>
				<option value="error">Error</option>
				<option value="correct">Corrected</option>
			</select>
            </div>  
            <div class="fitem">  
                <label>Facility:</label>  
                <input name="form_facility" class="easyui-validatebox" style="width: 280px"; required="true">  
            </div>  
            <div class="fitem">  
                <label>Comments:</label>  
				<textarea name="form_comments" style="height:60px; width: 280px;"></textarea>  
            </div>  
            <div class="fitem">  
                <label>Notes:</label>  
				<textarea name="form_notes" style="height:60px; width: 280px;"></textarea>
            </div>  
        </form>  
    </div>  
    <div id="dlg-buttons">  
        <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="saveUser()">Save</a>  
        <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')">Cancel</a>  
    </div> 
	
	<script type="text/javascript">  
        var url;  
        function newUser(){  
            $('#dlg').dialog('open').dialog('setTitle','New User');  
            $('#fm').form('clear');  
            url = 'save_user.php';  
        }  
        function editUser(){  
            var row = $('#dg').datagrid('getSelected');  
            if (row){  
                $('#dlg').dialog('open').dialog('setTitle','Result');  
                $('#fm').form('load',row);  
                url = './formcomments?id='+row.id;  
            }  
        }  
        function saveUser(){  
            $('#fm').form('submit',{ 
                url: url,  
                onSubmit: function(){  
                    return $(this).form('validate');  
                },  
                success: function(result){  
                    var result = eval('('+result+')');  
                    if (result.errorMsg){  
                        $.messager.show({  
                            title: 'Error',  
                            msg: result.errorMsg  
                        });  
                    } else {  
                        $('#dlg').dialog('close');      // close the dialog  
                        $('#dg').datagrid('reload');    // reload the user data  
                    }  
                }  
            });  
        }  
        function destroyUser(){  
            var row = $('#dg').datagrid('getSelected');  
            if (row){  
                $.messager.confirm('Confirm','Are you sure you want to destroy this user?',function(r){  
                    if (r){  
                        $.post('destroy_user.php',{id:row.id},function(result){  
                            if (result.success){  
                                $('#dg').datagrid('reload');    // reload the user data  
                            } else {  
                                $.messager.show({   // show error message  
                                    title: 'Error',  
                                    msg: result.errorMsg  
                                });  
                            }  
                        },'json');  
                    }  
                });  
            }  
        }  
    </script>  
    <style type="text/css">  
        #fm{  
            margin:0;  
            padding:10px 30px;  
        }  
        .ftitle{  
            font-size:14px;  
            font-weight:bold;  
            padding:5px 0;  
            margin-bottom:10px;  
            border-bottom:1px solid #ccc;  
        }  
        .fitem{  
            margin-bottom:5px;  
        }  
        .fitem label{  
            display:inline-block;  
            width:80px;  
        }  
    </style>

	