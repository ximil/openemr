<style type="text/css"> 
	#fm{  
		margin:0;  
		padding:10px 30px;  
	}  
	.ftitle{  
		font-size:14px;  
		font-weight:bold;  
		padding:5px 0;  
		margin-bottom:10px;  
		border-bottom:1px solid #ccc;  
	}  
	.fitem{  
		margin-bottom:5px;  
	}  
	.fitem label{  
		display:inline-block;  
		width:80px;  
	}  
</style>
<script type="text/javascript">
	$(function(){
		$('#dg').edatagrid({
			url: './resultShow', // show all the pending results
			saveUrl: './resultUpdate', // save the result 
			updateUrl: './resultUpdate',
			//destroyUrl: 'destroy_user.php'
		});
	});
	
	// Search options, Status and Ordered Date
	function doSearch(){
		$('#dg').edatagrid('load',{  
			statusOrder: $("input[name=searchStatusOrder]").val(),
			statusReport: $("input[name=searchStatusReport]").val(),
			statusResult: $("input[name=searchStatusResult]").val(),
			dtFrom: $('#acpro_inp1').val(),
			dtTo: $('#acpro_inp4').val(),
		}); 
	}
	
	// Result request with ordser id
	function getResult(target) {
		var tr = $(target).closest('tr.datagrid-row');
		var rowIndex = parseInt(tr.attr('datagrid-row-index'));
		$('#dg').datagrid('selectRow', rowIndex);
		var row = $('#dg').datagrid('getSelected'); 
		if (row){  
			var order_id = row.procedure_order_id;
			window.location.assign("./getlabresult?order_id=" + order_id);
		}
	}
	
	// Requisition request with ordser id
	function getRequisition(target) {
		var tr = $(target).closest('tr.datagrid-row');
		var rowIndex = parseInt(tr.attr('datagrid-row-index'));
		$('#dg').datagrid('selectRow', rowIndex);
		var row = $('#dg').datagrid('getSelected'); 
		if (row){  
			var order_id = row.procedure_order_id;
			window.location.assign("./getlabrequisition?order_id=" + order_id);
		}
	}
	
	/**
	* Show Popup and edit Result Status, Fecility, Comments and Notes
	*/
	var url;  
	function editComments(target){
		var tr = $(target).closest('tr.datagrid-row');
		var rowIndex = parseInt(tr.attr('datagrid-row-index'));
		$('#dg').datagrid('selectRow', rowIndex);
		var row = $('#dg').datagrid('getSelected');
		if (row.editor == 0) {
			if (row){
				$('#dlg').dialog('open').dialog('setTitle','Result');
				$('#titleShow').html(row.result_text);
				$.ajax({
					type: "POST",
					cache: false,
					dataType: "json",
					url: "./getResultComments",
					data: {
						prid: row.procedure_result_id,
						},
					success: function(data) {
						$.each(data, function(entryIndex, entry){
							$("input[name=formResultStatus]").val(entry['result_status']);
							$("input[name=formResultFacility]").val(entry['facility']);
							$('#formResultComments').val(entry['comments']);
							$('#formResultNotes').val(entry['notes']);
							$('#cc').combobox('setValue',$.trim(entry['result_status']));
							$('#acpro_inp19').val(entry['title']);
							/* $("#cc option").filter(function() {
								return $(this).val() == entry['result_status'];
							}).get(0).selected = true; */
						});
					},
					error: function(data){
						//alert("Ajax Fail");
					}
				});		
				$('#fm').form('load',row);
				url	= '';		
			}
		}
	} 

	// Save the Popup form details to field comments
	function saveComments() {
		var row = $('#dg').datagrid('getSelected');
		if (row){
			row.comments = $("input[name=formResultStatus]").val() + '|' + $("input[name=formResultFacility]").val() + '|' + $("#formResultComments").val() + '|' + $("#formResultNotes").val();
		}
		$('#dlg').dialog('close');
	}

	// Freezing cells 
	$(function(){ 
		$('#dg').edatagrid({ 
			onSelect:function(rowIndex, rowData){
				//$('#dg').edatagrid('cancelRow');
				//var curRow = $('#dg').datagrid('selectRow', rowIndex);
				//$('#dg').datagrid('unselectAll');
				var row = $('#dg').datagrid('getSelected');
				$('#rem').html(row.procedure_name + '|' + rowIndex);
				var fieldValue = $.trim(rowData.procedure_name);
				var editor = rowData.editor;
				if (editor == 1) {
					alert('Disabled');
					$('#dg').edatagrid('cancelRow');
					$('#dg').edatagrid('cancelEdit')
				}
				if (rowIndex == 0) {
					$('#datagrid-row-r2-2-0').focus();
				}
				
				if (fieldValue.length == 0 || editor == 1) {
					var opts = $('#dg').datagrid('getColumnOption', 'date_report');
					opts.editor = {
						type:'',
					
					};
					var opts = $('#dg').datagrid('getColumnOption', 'date_collected');
					opts.editor = {
						type:'',
					
					};
					var opts = $('#dg').datagrid('getColumnOption', 'specimen_num');
					opts.editor = {
						type:'',
					
					};
					var opts = $('#dg').datagrid('getColumnOption', 'report_status');
					opts.editor = {
						type:'',
					
					};
					if (editor == 1) {
						var opts = $('#dg').datagrid('getColumnOption', 'abnormal');
							opts.editor = {
							type:'',
					
						};
						var opts = $('#dg').datagrid('getColumnOption', 'result');
							opts.editor = {
							type:'',
					
						};
						var opts = $('#dg').datagrid('getColumnOption', 'pt2_units');
							opts.editor = {
							type:'',
					
						};
						var opts = $('#dg').datagrid('getColumnOption', 'pt2_range');
							opts.editor = {
							type:'',
					
						};
					}
				} else {
					var opts = $('#dg').datagrid('getColumnOption', 'date_report');
					opts.editor = {
						type:'datebox',
						options:{
							required:true
						}
					};
					var opts = $('#dg').datagrid('getColumnOption', 'date_collected');
					opts.editor = {
						type:'datebox',
					
					};
					var opts = $('#dg').datagrid('getColumnOption', 'specimen_num');
					opts.editor = {
						type:'text',
					
					};
					var opts = $('#dg').datagrid('getColumnOption', 'report_status');
					opts.editor = {
						type:'combobox',
						options:{  
							valueField:'option_id',  
							textField:'title',  
							url:'./getLabStatus',  
							required:false  
						} 
					};
					//if (editor == 0) {
						var opts = $('#dg').datagrid('getColumnOption', 'abnormal');
							opts.editor = {
							type:'combobox',
							options:{  
									valueField:'option_id',  
									textField:'title',  
									url:'./getLabAbnormal',  
									required:false  
								} 
						};
						var opts = $('#dg').datagrid('getColumnOption', 'result');
							opts.editor = {
							type:'text',
					
						};
						var opts = $('#dg').datagrid('getColumnOption', 'pt2_units');
							opts.editor = {
							type:'text',
					
						};
						var opts = $('#dg').datagrid('getColumnOption', 'pt2_range');
							opts.editor = {
							type:'text',
					
						};
					//}
				}
				fieldValue = '';
				//$('#dg').datagrid('unselectRow',rowIndex);
			},
		});
	});
  
</script>
<span id='rem'></span>
	<table id="dg" title="Pending Review"  style="width:auto;height:600px"
			toolbar="#toolbar" pagination="true" idField="procedure_order_id, procedure_result_id, procedure_order_seq, procedure_report_id, editor"
			rownumbers="true" pageSize="20" fitColumns="true" singleSelect="true">
			<thead data-options="frozen:true">
				<tr>
					<th colspan="6"><?php echo xlt('Order'); ?></th>
				</tr>
			</thead>
			<thead>
			<tr>
				<th colspan="4"><?php echo xlt('Report'); ?></th>
				<th colspan="7"><?php echo xlt('Results and Recommendations'); ?></th>
				<th colspan="1"><?php echo xlt('Action'); ?></th>
			</tr>
			</thead>
			<thead data-options="frozen:true">
				<tr>
					<!-- Start Order -->
					<th data-options="field:'date_ordered'"><?php echo xlt('Date'); ?></th>
					<th data-options="field:'procedure_name'"><?php echo xlt('Procedure Name'); ?></th> 
					<th data-options="field:'order_id', align:'center'"><?php echo xlt('Ord'); ?></th> 
					<th data-options="field:'patient_name'"><?php echo xlt('Patient'); ?></th>
					<th data-options="field:'encounter_id', align:'center'"><?php echo xlt('Encounter'); ?></th>
					<th data-options="field:'order_status'"><?php echo xlt('Status'); ?></th>
					<!-- End Order -->
				</tr>
			<thead>
			
			<tr>
			
			<!-- Start Report -->
				<th field="date_report" editor="{type:'datebox',options:{required:true}}"><?php echo xlt('Reported'); ?><span style="margin-left: 30px;"></span></th>
				<th field="date_collected" editor="{type:'datebox'}" ><?php echo xlt('Ext Time Collected'); ?><span style="margin-left: 30px;"></span></th>
							
				<!--<th class="easyui-datetimebox" name="birthday"   
        data-options="field='date_collected',required:true,showSeconds:false" value="3/4/2010 2:3" style="width:150px"></th>-->
				<th field="specimen_num" editor="text"><?php echo xlt('Specimen'); ?></th>
				<th data-options="field:'report_status',  
							formatter:function(value,row){  
								return row.report_title;  
							},  
							editor:{  
								type:'combobox',  
								options:{  
									valueField:'option_id',  
									textField:'title',  
									url:'./getLabStatus',  
									required:false  
								} 
							}"><?php echo xlt('Status'); ?><span style="margin-left: 30px;"></span></th>
			<!-- End Report -->
			
			<!-- Start Results and Recommendations -->
				<!--<th field="result_code" width="40" editor="text"><?php echo xlt('Code'); ?></th>
				<th field="result_text" width="80" editor="text"><?php echo xlt('Name'); ?></th>-->
				<th data-options="field:'result_code', align:'center'"><?php echo xlt('Code'); ?></th>
				<th data-options="field:'result_text', align:'left'"><?php echo xlt('Name'); ?></th>
				<th data-options="field:'abnormal',  
							formatter:function(value,row){  
								return row.abnormal_title;  
							},  
							editor:{  
								type:'combobox',  
								options:{  
									valueField:'option_id',  
									textField:'title',  
									url:'./getLabAbnormal',  
									required:false  
								} 
							}"><?php echo xlt('Abn'); ?><span style="margin-left: 10px;"></span></th>
				<th field="result" editor="text"><?php echo xlt('Value'); ?></th>
				<th field="pt2_units" editor="text"><?php echo xlt('Units'); ?></th>
				<th field="pt2_range" editor="text"><?php echo xlt('Range'); ?></th>
				<th data-options="field:'comments',title:'',align:'center',
							formatter:function(value,row,index){
								if (row.editing){
									var s = '<a></a> ';
									var c = '<a></a>';
									return s+c;
								} else {
									var r = '<a href=javascript:void(0) class=easyui-linkbutton iconCls=icon-edit plain=true onclick=editComments(this)><img src=<?php echo $this->basePath() ?>/css/icons/pencil.png /></a>';
									var q = '';
									return r+q;
								}
							}"><?php echo xlt('Comments'); ?></th>

			<!-- End Results and Recommendations -->
				<th data-options="field:'action',title:'',align:'left',
							formatter:function(value,row,index){
								if (row.editing){
									var s = '<a></a> ';
									var c = '<a></a>';
									return s+c;
								} else {
									var d = '<a href=\'#\' onClick=\'getRequisition(this);\' style=padding-left:30px;><img  src=<?php echo $this->basePath() .'/css/icons/request.png'; ?> title=<?php echo xlt('Requisition'); ?> border=0 /></a>';
									var e = '<a href=\'#\' onClick=\'getResult(this);\' style=padding-left:40px;><img  src=<?php echo $this->basePath() .'/css/icons/pdf_icon.png'; ?> title=<?php echo xlt('Result'); ?>  border=0 /></a>';
									return d+e;
								}
							}">
							<span class="datagrid-cell" style="border-right: 1px dotted #444;">
							<?php echo xlt('Requisition'); ?></span>
							<span>
							<?php echo xlt('Result'); ?>
							</span>
							</th>
		
			<!-- End Action -->
			</tr>
		</thead>
	</table>

	<div id="toolbar">
		<a href="#" class="easyui-linkbutton" iconCls="icon-save" plain="true" onclick="javascript:$('#dg').edatagrid('saveRow')"><?php echo xlt('Save'); ?></a>
		<a href="#" class="easyui-linkbutton" iconCls="icon-undo" plain="true" onclick="javascript:$('#dg').edatagrid('cancelRow')"><?php echo xlt('Cancel'); ?></a>

		<div style="text-align: right;">
		<div style="text-align: left;">
			<span style="text-align: left; font-weight: bold; margin-left: 220px;"><?php echo xlt('Date'); ?></span>
			<span style="text-align: left; font-weight: bold; margin-left: 270px;"><?php echo xlt('Status'); ?></span>
		</div>
			<span style="text-align: left; padding-right: 30px;">
			<?php echo xlt('From'); ?>: <input class="easyui-datebox" style="width:80px" >
			</span>
			<span style="text-align: left; padding-right: 50px;">
			<?php echo xlt('To'); ?>: <input class="easyui-datebox" style="width:80px" >
			</span>
			<?php //echo xlt('Status'); ?>
			<span style="text-align: left; padding-right: 10px;">
			<?php echo xlt('Order'); ?>
			<input id="searchStatusOrder" class="easyui-combobox" name="searchStatusOrder" 
    data-options="valueField:'option_id',textField:'title',url:'./getLabOptions?opt=search&optId=order'" />
			</span>
			<span style="text-align: left; padding-right: 10px;">
			<?php echo xlt('Report'); ?>
			<input id="cc" class="easyui-combobox" name="searchStatusReport" 
    data-options="valueField:'option_id',textField:'title',url:'./getLabOptions?opt=search&optId=report'" />
			</span>
			<span style="text-align: left; padding-right: 10px;">
			<?php echo xlt('Result'); ?>
			<input id="searchStatusResult" class="easyui-combobox" name="searchStatusResult" 
    data-options="valueField:'option_id',textField:'title',url:'./getLabOptions?opt=search&optId=result'" />
			</span>

			<a href="#" class="easyui-linkbutton" iconCls="icon-search" plain="true" onclick="doSearch()"><?php echo xlt('Search'); ?></a>

		</div>
	</div>
	
	<div id="dlg" class="easyui-dialog" style="width:500px;height:380px;padding:10px 20px"  
            closed="true" buttons="#dlg-buttons">  
        <div class="ftitle" id='titleShow'></div>  
        <form id="fm" method="post" novalidate>  
            <div class="fitem">  
                <label><?php echo xlt('Status'); ?>:</label>  
			<input id="cc" class="easyui-combobox" name="formResultStatus" 
    data-options="valueField:'option_id',textField:'title', url:'./getLabOptions?opt=status&optId=result'" />
            </div>  
            <div class="fitem">  
                <label><?php echo xlt('Facility'); ?>:</label>  
                <input name="formResultFacility" class="easyui-validatebox" style="width: 280px"; >  
            </div>  
            <div class="fitem">  
                <label><?php echo xlt('Comments'); ?>:</label>  
				<textarea id='formResultComments' name="formResultComments" style="height:60px; width: 280px;"></textarea>  
            </div>  
            <div class="fitem">  
                <label><?php echo xlt('Notes'); ?>:</label>  
				<textarea id='formResultNotes' name="formResultNotes" style="height:60px; width: 280px;"></textarea>
            </div>  
        </form>  
    </div>  
    <div id="dlg-buttons">  
        <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" onclick="saveComments()"><?php echo xlt('Close'); ?></a>  
    </div> 

  
	